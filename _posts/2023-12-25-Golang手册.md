---
layout: post
title: Golangæ‰‹å†Œ
subtitle: 
cover-img: 
thumbnail-img: /assets/img/golang.png
share-img: 
tags: [install]
author: Jamie
---

## LearnDocs ğŸ‡¨ğŸ‡³ğŸ‡¨ğŸ‡³ğŸ‡¨ğŸ‡³

#### Benchmark

* åŸºç¡€è¯´æ˜

- benchmark å’Œæ™®é€šçš„å•å…ƒæµ‹è¯•ç”¨ä¾‹ä¸€æ ·ï¼Œéƒ½æ˜¯åœ¨_test.goæ–‡ä»¶ä¸­
- å‡½æ•°åä»¥Benchmarkå¼€å¤´
- b.N çš„å€¼å¤§æ¦‚ä»¥ 1, 2, 3, 5, 10, 20, 30, 50, 100 è¿™æ ·çš„åºåˆ—é€’å¢ï¼Œè¶Šåˆ°åé¢ï¼Œå¢åŠ å¾—è¶Šå¿«
- å‚æ•°æ˜¯`b *testing.B` æ™®é€šæµ‹è¯•ç”¨ä¾‹æ˜¯ `b *testing.T`
- è¿è¡Œï¼š`go test -bench .`

```go
func BenchmarkFib(b *testing.B) {
	time.Sleep(3 * time.Second)
	b.ResetTimer() // é‡ç½®å®šæ—¶å™¨ï¼Œé¿å…å‡†å¤‡ä»»åŠ¡çš„è€—æ—¶å¹²æ‰°
	for n := 0; n < b.N; n++ {
		fib(30) // run fib(30) b.N times
	}
}
```

* å‚æ•°è¯´æ˜

- åªè¿è¡Œï¼š`go test -bench='Fib$'`
- é€šè¿‡`-cpu`ä¿®æ”¹cpuçš„æ ¸æ•°ï¼Œæ”¯æŒä¼ å…¥ä¸€ä¸ªåˆ—è¡¨
- é€šè¿‡`-benchtime`ä¿®æ”¹æ‰§è¡Œå¤šå°‘æ¬¡ï¼Œæˆ–è€…å¤šé•¿æ—¶é—´ 5s æˆ–è€… 30x
- é€šè¿‡`-count`ä¿®æ”¹benchmarkçš„è½®æ•° 3
- é€šè¿‡`-benchmen`å‚æ•°æŸ¥çœ‹å†…å­˜åˆ†é…æƒ…å†µ
- ä»£ç å†…ï¼Œ`b.ResetTimer()`å¯ä»¥å¯¹è€—æ—¶å‡†å¤‡ä»»åŠ¡çš„æ—¶é—´è¿›è¡Œå»é™¤
- ä»£ç å†…ï¼Œ`b.StopTimer()` å’Œ `b.StartTimer()` å¯ä»¥è·³è¿‡å‡†å¤‡å·¥ä½œå’Œæ¸…ç†å·¥ä½œ

```shell
âœ  go go test -bench='Fib$' -cpu=1 -benchtime=200x -count=3 -benchmem
goos: darwin
goarch: arm64
pkg: example/go
BenchmarkFib         200           3730384 ns/op               0 B/op          0 allocs/op
BenchmarkFib         200           3677236 ns/op               0 B/op          0 allocs/op
BenchmarkFib         200           3608414 ns/op               0 B/op          0 allocs/op
PASS
ok      example/go      2.223s
```

> è¾“å‡ºè¯´æ˜

- `BenchmarkFib-2` å¤šå°‘ä¸ªcpuä¸Šæ‰§è¡Œçš„
- `330` æ‰§è¡Œäº†å¤šå°‘æ¬¡
- `3630851` æ¯æ¬¡æ‰§è¡Œè€—è´¹çš„nsï¼Œæ¢ç®—ä¸º0.003s

```shell
# å®ç”¨å‘½ä»¤
go test -benchmem -run=^$ -bench ^BenchmarkProcessReduce$ bsfl/test -count=1 -benchtime=1x -cpu=8 -memprofile=mem.out
go tool pprof mem.out
```


### pprof

```shell
# å¯åŠ¨ä¸€ä¸ªwabæœåŠ¡è§‚å¯Ÿ
go tool pprof -http=0.0.0.0:8000 http://127.0.0.1:10000/debug/pprof/allocs
go tool pprof -http=:9999 allocs
go tool pprof allocs
# åŠ è½½æ–‡ä»¶
go tool pprof -http=0.0.0.0:8000 -files
# CPU
go tool pprof http://127.0.0.1:10000/debug/pprof/profile
# MEM
go tool pprof http://127.0.0.1:10000/debug/pprof/heap
```

### æµ‹è¯•ç”¨ä¾‹

```shell
ç”ŸæˆæŠ¥å‘Šï¼Œè®¡ç®—è¦†ç›–ç‡
ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Šæ–‡ä»¶
go test -v -covermode=count -coverprofile=cover.out

ä½¿ç”¨ go tool è½¬æˆ html æ ¼å¼
go tool cover -html=cover.out -o cover.html
```